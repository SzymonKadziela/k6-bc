name: Performance Testing CI

# Kiedy test ma się uruchomić?
on:
  push:
    branches: [ "main" ] # Uruchom na push do gałęzi main
  pull_request:
    branches: [ "main" ] # Uruchom na Pull Requesty do main
  workflow_dispatch:      # Dodatkowa opcja: uruchamianie ręczne z GUI GitHub

jobs:
  performance_test:
    name: Uruchomienie Testu k6
    runs-on: ubuntu-latest # Testy puszczamy na maszynie wirtualnej Linuxa

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 
        
      # KROK 1: INSTALACJA K6 (Najbardziej stabilna metoda)
      - name: Install k6
        run: sudo sh -c "echo 'deb [trusted=yes] https://dl.k6.io/deb stable main' > /etc/apt/sources.list.d/k6.list && apt update && apt install k6"
        
      # KROK 2: Uruchomienie testu
      - name: Run k6 Load Test
        run: k6 run tests/smoke-test.js
        env:
          # WAŻNE: W CI/CD używamy domyślnego publicznego adresu (test.k6.io)
          BASE_URL: ${{ vars.DEFAULT_BASE_URL || 'https://test.k6.io' }} 

      # KROK 3: Sprawdzenie wyniku (Jeśli k6 zwróci błąd progu, GitHub Actions zwróci błąd)
      - name: Check K6 Results
        if: always()
        run: echo "Test zakończony."