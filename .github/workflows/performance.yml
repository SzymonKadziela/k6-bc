name: Performance Testing CI

# Kiedy test ma się uruchomić?
on:
  push:
    branches: [ "main" ] # Uruchom na push do gałęzi main
  pull_request:
    branches: [ "main" ] # Uruchom na Pull Requesty do main
  workflow_dispatch:      # Dodatkowa opcja: uruchamianie ręczne z GUI GitHub

jobs:
  performance_test:
    name: Uruchomienie Testu k6
    runs-on: ubuntu-latest # Testy puszczamy na maszynie wirtualnej Linuxa

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 
        
      # KROK 1: POBIERANIE I INSTALACJA KLUCZA GPG w nowoczesny sposób
      - name: Add K6 GPG Key and Repository
        run: |
          # Pobieramy klucz GPG za pomocą curl i umieszczamy go w zaufanym katalogu
          sudo curl -fsSL https://dl.k6.io/keys/k6-archive.key | sudo gpg --dearmor -o /etc/apt/keyrings/k6-archive-keyring.gpg
          
          # Dodajemy repozytorium k6 używając nowoczesnej składni
          echo "deb [signed-by=/etc/apt/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          
      # KROK 2: Aktualizacja listy pakietów
      - name: Update apt lists
        run: sudo apt-get update

      # KROK 3: Instalacja k6
      - name: Install k6
        run: sudo apt-get install k6

      # KROK 4: Uruchomienie testu
      - name: Run k6 Load Test
        run: k6 run ${{ github.workspace }}/tests/smoke-test.js
        env:
          BASE_URL: ${{ vars.DEFAULT_BASE_URL || 'https://test.k6.io' }}

      # KROK 5: Sprawdzenie wyniku (Niezmienne)
      - name: Check K6 Results
        if: always()
        run: |
          echo "K6 test completed with exit code $?"
          if [ $? -ne 0 ]; then
            echo "Test FAILED due to Threshold/SLA breach."
            exit 1
          fi